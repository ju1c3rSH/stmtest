<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PID Tuner - Material 3 Style</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --md-primary: #1a73e8;
      --md-on-primary: #ffffff;
      --md-surface: #ffffff;
      --md-on-surface: #1d1b20;
      --md-outline: #757575;
      --md-background: #f5f5f5;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 16px;
      background: var(--md-background);
      color: var(--md-on-surface);
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: var(--md-surface);
      border-radius: 28px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    h1 {
      margin-top: 0;
      color: var(--md-primary);
      font-weight: 500;
      font-size: 24px;
    }

    .control-row {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      align-items: center;
      flex-wrap: wrap;
    }

    select {
      padding: 10px 16px;
      font-size: 16px;
      border: 1px solid var(--md-outline);
      border-radius: 20px;
      background: white;
      min-width: 180px;
    }

    button {
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .submit-btn {
      background: var(--md-primary);
      color: var(--md-on-primary);
      padding: 10px 20px;
      font-size: 16px;
    }

    .submit-btn:hover {
      background: #1557b0;
    }

    .param-section {
      display: none;
    }

    .param-section.active {
      display: block;
    }

    .param-row {
      display: flex;
      align-items: center;
      margin: 16px 0;
    }

    .param-label {
      width: 100px;
      font-size: 14px;
      font-weight: 500;
    }

    input[type="range"] {
      flex: 1;
      height: 32px;
      -webkit-appearance: none;
      background: transparent;
      margin: 0 12px;
    }

    input[type="range"]::-webkit-slider-runnable-track {
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 24px;
      width: 24px;
      border-radius: 50%;
      background: var(--md-primary);
      margin-top: -10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .value-input {
      width: 90px;
      padding: 6px 8px;
      font-family: 'Roboto', monospace;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 8px;
      text-align: right;
      margin-left: 8px;
    }

    /* ä¸²å£ç›‘è§†å™¨ */
    .monitor {
      margin-top: 24px;
      padding: 12px;
      background: #2d2d2d;
      border-radius: 16px;
      color: #0f0;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .log-line {
      margin: 0;
      line-height: 1.4;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>PID å‚æ•°è°ƒè°å™¨</h1>

    <div class="control-row">
      <select id="pidType">
        <option value="balance_pitch">å¹³è¡¡ Pitch</option>
        <option value="balance_yaw">åèˆª Yaw</option>
        <option value="speed">é€Ÿåº¦ Speed</option>
      </select>
      <button class="submit-btn" id="submitBtn">æäº¤å¹¶ç­‰å¾…é‡å¯</button>
    </div>

    <!-- Pitch -->
    <div class="param-section" id="section_pitch">
      <h3>å¹³è¡¡ Pitch</h3>
      <div class="param-row">
        <span class="param-label">Kp</span>
        <input type="range" id="pitch_kp" min="0" max="2000" step="0.001" value="850">
        <input type="text" id="pitch_kp_input" class="value-input" value="850.000">
      </div>
      <div class="param-row">
        <span class="param-label">Ki</span>
        <input type="range" id="pitch_ki" min="0" max="10" step="0.001" value="0">
        <input type="text" id="pitch_ki_input" class="value-input" value="0.000">
      </div>
      <div class="param-row">
        <span class="param-label">Kd</span>
        <input type="range" id="pitch_kd" min="0" max="10" step="0.001" value="2.6">
        <input type="text" id="pitch_kd_input" class="value-input" value="2.600">
      </div>
    </div>

    <!-- Yaw -->
    <div class="param-section" id="section_yaw">
      <h3>åèˆª Yaw</h3>
      <div class="param-row">
        <span class="param-label">Kp</span>
        <input type="range" id="yaw_kp" min="0" max="100" step="0.001" value="30">
        <input type="text" id="yaw_kp_input" class="value-input" value="30.000">
      </div>
      <div class="param-row">
        <span class="param-label">Ki</span>
        <input type="range" id="yaw_ki" min="0" max="10" step="0.001" value="0">
        <input type="text" id="yaw_ki_input" class="value-input" value="0.000">
      </div>
      <div class="param-row">
        <span class="param-label">Kd</span>
        <input type="range" id="yaw_kd" min="0" max="10" step="0.001" value="1">
        <input type="text" id="yaw_kd_input" class="value-input" value="1.000">
      </div>
    </div>

    <!-- Speed -->
    <div class="param-section" id="section_speed">
      <h3>é€Ÿåº¦ Speed</h3>
      <div class="param-row">
        <span class="param-label">Kp</span>
        <input type="range" id="speed_kp" min="0" max="10" step="0.001" value="1">
        <input type="text" id="speed_kp_input" class="value-input" value="1.000">
      </div>
      <div class="param-row">
        <span class="param-label">Ki</span>
        <input type="range" id="speed_ki" min="0" max="5" step="0.001" value="0.1">
        <input type="text" id="speed_ki_input" class="value-input" value="0.100">
      </div>
      <div class="param-row">
        <span class="param-label">Kd</span>
        <input type="range" id="speed_kd" min="0" max="1" step="0.001" value="0.01">
        <input type="text" id="speed_kd_input" class="value-input" value="0.010">
      </div>
    </div>

    <div class="monitor" id="monitor">
      <p class="log-line">ä¸²å£ç›‘è§†å™¨ï¼ˆç­‰å¾…è¿æ¥...ï¼‰</p>
    </div>
  </div>

  <script>
    let currentPort = null;
    let isConnected = false;
    let logLines = [];
    const monitorEl = document.getElementById('monitor');
    const pidTypeSelect = document.getElementById('pidType');
    const submitBtn = document.getElementById('submitBtn');

    let connectBtn = null;
    let downloadBtn = null;
    let clearLogBtn = null;

    const paramConfig = {
      pitch_kp: { min: 0, max: 2000, step: 0.001, decimals: 3 },
      pitch_ki: { min: 0, max: 10, step: 0.001, decimals: 3 },
      pitch_kd: { min: 0, max: 10, step: 0.001, decimals: 3 },
      yaw_kp: { min: 0, max: 100, step: 0.001, decimals: 3 },
      yaw_ki: { min: 0, max: 10, step: 0.001, decimals: 3 },
      yaw_kd: { min: 0, max: 10, step: 0.001, decimals: 3 },
      speed_kp: { min: 0, max: 10, step: 0.001, decimals: 3 },
      speed_ki: { min: 0, max: 5, step: 0.001, decimals: 3 },
      speed_kd: { min: 0, max: 1, step: 0.001, decimals: 3 }
    };

    Object.keys(paramConfig).forEach(id => {
      const slider = document.getElementById(id);
      const input = document.getElementById(`${id}_input`);
      const config = paramConfig[id];

      slider.addEventListener('input', () => {
        const val = parseFloat(slider.value);
        input.value = val.toFixed(config.decimals);
      });

      input.addEventListener('change', () => {
        let val = parseFloat(input.value);
        if (isNaN(val)) val = config.min;
        val = Math.max(config.min, Math.min(config.max, val));
        slider.value = val;
        input.value = val.toFixed(config.decimals);
      });

      input.value = parseFloat(slider.value).toFixed(config.decimals);
    });

    pidTypeSelect.addEventListener('change', () => {
      document.querySelectorAll('.param-section').forEach(el => el.classList.remove('active'));
      const type = pidTypeSelect.value;
      const sectionMap = {
        'balance_pitch': 'section_pitch',
        'balance_yaw': 'section_yaw',
        'speed': 'section_speed'
      };
      document.getElementById(sectionMap[type]).classList.add('active');
    });

    document.getElementById('section_pitch').classList.add('active');

    function log(msg) {
      const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logLines.push(line);
      if (logLines.length > 100) logLines.shift();
      monitorEl.innerHTML = logLines.map(l => `<p class="log-line">${l}</p>`).join('');
      monitorEl.scrollTop = monitorEl.scrollHeight;
    }

    function clearLog() {
      logLines = [];
      monitorEl.innerHTML = '<p class="log-line">æ—¥å¿—å·²æ¸…ç©º</p>';
    }

    async function readFromPort(port) {
      const reader = port.readable.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      try {
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();
          for (const line of lines) {
            const cleanLine = line.trim();
            if (!cleanLine) continue;
            log(`â† ${cleanLine}`);
            try {
              const jsonObj = JSON.parse(cleanLine);
              if (jsonObj.data) {
                updateSliders(jsonObj.data);
                log("âœ… è‡ªåŠ¨åŠ è½½è®¾å¤‡å‚æ•°");
              }
            } catch (e) { }
          }
        }
      } catch (e) {
        if (isConnected) {
          log(`âŒ è¯»å–ä¸­æ–­: ${e.message}`);
        }
      } finally {
        reader.releaseLock();
        if (isConnected) {
          handleDisconnect();
        }
      }
    }

    async function sendJSON(jsonStr) {
      if (!isConnected || !currentPort?.writable) {
        log("âŒ ä¸²å£æœªè¿æ¥");
        return false;
      }

      try {
        const writer = currentPort.writable.getWriter();
        await writer.write(new TextEncoder().encode(jsonStr + "\n"));
        writer.releaseLock();
        log(`â†’ ${jsonStr}`);
        return true;
      } catch (e) {
        log(`âŒ å‘é€å¤±è´¥: ${e.message}`);
        //å¼ºåˆ¶æ–­å¼€
        isConnected = false;
        updateUI();
        return false;
      }
    }

    function updateSliders(dataObj) {
      const fields = ['pitch_kp', 'pitch_ki', 'pitch_kd', 'yaw_kp', 'yaw_ki', 'yaw_kd', 'speed_kp', 'speed_ki', 'speed_kd'];
      fields.forEach(field => {
        if (dataObj[field] !== undefined) {
          const slider = document.getElementById(field);
          const input = document.getElementById(`${field}_input`);
          const val = parseFloat(dataObj[field]);
          slider.value = val;
          input.value = val.toFixed(3);
        }
      });
    }

    function updateUI() {
      if (!connectBtn) return;

      connectBtn.textContent = isConnected ? "æ–­å¼€ä¸²å£" : "è¿æ¥ä¸²å£";
      submitBtn.disabled = !isConnected;
    }
    async function handleConnect() {
      // å¼ºåˆ¶å…ˆæ–­å¼€
      if (isConnected) await handleDisconnect();

      try {
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });

        currentPort = port;
        isConnected = true;
        updateUI();
        log("âœ… ä¸²å£å·²è¿æ¥");
        readFromPort(port);
      } catch (error) {
        isConnected = false;
        updateUI();
        log(`âŒ ${error.message || 'ä¸²å£è¿æ¥å¤±è´¥'}`);
      }
    }

    async function handleDisconnect() {
      if (!currentPort) {
        isConnected = false;
        return;
      }

      try {
        if (currentPort.readable) {
          const reader = currentPort.readable.getReader();
          await reader.cancel();
          reader.releaseLock();
        }
        await currentPort.close();
      } catch (e) { }
      finally {
        currentPort = null;
        isConnected = false;
        if (connectBtn) connectBtn.textContent = "è¿æ¥ä¸²å£";
        log("ğŸ”Œ ä¸²å£å·²æ–­å¼€");
      }
    }

    submitBtn.addEventListener('click', async () => {
      if (!isConnected || !currentPort?.writable) {
        log("âš ï¸ ä¸²å£æœªè¿æ¥");
        return;
      }

      const type = pidTypeSelect.value; // å½“å‰é€‰ä¸­çš„ç±»å‹
      const prefix = type.split('_')[1];

      // ä»è¾“å…¥æ¡†è·å–å€¼ï¼ˆç¡®ä¿ç²¾åº¦ï¼‰
      const kp = parseFloat(document.getElementById(`${prefix}_kp_input`).value) || 0;
      const ki = parseFloat(document.getElementById(`${prefix}_ki_input`).value) || 0;
      const kd = parseFloat(document.getElementById(`${prefix}_kd_input`).value) || 0;

      const jsonToSend = `{"type":"${type}","kp":${kp.toFixed(3)},"ki":${ki.toFixed(3)},"kd":${kd.toFixed(3)}}`;
      log(`ğŸ“¤ å‘é€: ${jsonToSend}`);

      const success = await sendJSON(jsonToSend);
      if (success) {
        // ç­‰å¾…è®¾å¤‡é‡å¯
        submitBtn.disabled = true;
        submitBtn.textContent = "ç­‰å¾…é‡å¯...";

        await new Promise(r => setTimeout(r, 300));
        await handleDisconnect();

        await new Promise(r => setTimeout(r, 2000));
        await handleConnect();

        submitBtn.disabled = false;
        submitBtn.textContent = "æäº¤å¹¶ç­‰å¾…é‡å¯";
      }
    });
    function downloadCurrentConfig() {
      const config = {
        balance_pitch: {
          type: "balance_pitch",
          kp: parseFloat(pitch_kp_input.value),
          ki: parseFloat(pitch_ki_input.value),
          kd: parseFloat(pitch_kd_input.value)
        },
        balance_yaw: {
          type: "balance_yaw",
          kp: parseFloat(yaw_kp_input.value),
          ki: parseFloat(yaw_ki_input.value),
          kd: parseFloat(yaw_kd_input.value)
        },
        speed: {
          type: "speed",
          kp: parseFloat(speed_kp_input.value),
          ki: parseFloat(speed_ki_input.value),
          kd: parseFloat(speed_kd_input.value)
        }
      };

      const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'pid_config_backup.json';
      a.click();
      URL.revokeObjectURL(url);
      log("å·²ä¸‹è½½å½“å‰é…ç½®");
    }

    // ========== åˆå§‹åŒ– UI ==========
    document.addEventListener('DOMContentLoaded', () => {
      const btnContainer = document.createElement('div');
      btnContainer.style.display = 'flex';
      btnContainer.style.gap = '10px';
      btnContainer.style.marginTop = '12px';
      btnContainer.style.flexWrap = 'wrap';

      connectBtn = document.createElement('button');
      connectBtn.textContent = "è¿æ¥ä¸²å£";
      connectBtn.onclick = () => {
        if (isConnected) {
          handleDisconnect();
        } else {
          handleConnect();
        }
      };
      btnContainer.appendChild(connectBtn);

      downloadBtn = document.createElement('button');
      downloadBtn.textContent = "ä¸‹è½½é…ç½®";
      downloadBtn.style.backgroundColor = "#34a853";
      downloadBtn.style.color = "white";
      downloadBtn.onclick = downloadCurrentConfig;
      btnContainer.appendChild(downloadBtn);

      clearLogBtn = document.createElement('button');
      clearLogBtn.textContent = "æ¸…ç©ºæ—¥å¿—";
      clearLogBtn.style.backgroundColor = "#ea4335";
      clearLogBtn.style.color = "white";
      clearLogBtn.onclick = clearLog;
      btnContainer.appendChild(clearLogBtn);

      
      querySelector('.control-row').appendChild(btnContainer);
      updateUI();
      log("ç‚¹å‡»ã€Œè¿æ¥ä¸²å£ã€å¼€å§‹");
    });
  </script>
</body>

</html>