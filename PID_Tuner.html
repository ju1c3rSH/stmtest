<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PID Tuner - Material 3 Style</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --md-primary: #1a73e8;
      --md-on-primary: #ffffff;
      --md-surface: #ffffff;
      --md-on-surface: #1d1b20;
      --md-outline: #757575;
      --md-background: #f5f5f5;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 16px;
      background: var(--md-background);
      color: var(--md-on-surface);
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: var(--md-surface);
      border-radius: 28px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    h1 {
      margin-top: 0;
      color: var(--md-primary);
      font-weight: 500;
      font-size: 24px;
    }

    .control-row {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
      align-items: center;
    }

    select {
      padding: 10px 16px;
      font-size: 16px;
      border: 1px solid var(--md-outline);
      border-radius: 20px;
      background: white;
      min-width: 180px;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      font-weight: 500;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .submit-btn {
      background: var(--md-primary);
      color: var(--md-on-primary);
    }

    .submit-btn:hover {
      background: #1557b0;
    }

    .param-section {
      display: none;
    }

    .param-section.active {
      display: block;
    }

    .param-row {
      display: flex;
      align-items: center;
      margin: 16px 0;
    }

    .param-label {
      width: 100px;
      font-size: 14px;
      font-weight: 500;
    }

    input[type="range"] {
      flex: 1;
      height: 32px;
      -webkit-appearance: none;
      background: transparent;
      margin: 0 12px;
    }

    input[type="range"]::-webkit-slider-runnable-track {
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 24px;
      width: 24px;
      border-radius: 50%;
      background: var(--md-primary);
      margin-top: -10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .value-display {
      min-width: 60px;
      text-align: right;
      font-size: 14px;
      font-weight: 500;
    }

    /* ä¸²å£ç›‘è§†å™¨ */
    .monitor {
      margin-top: 24px;
      padding: 12px;
      background: #2d2d2d;
      border-radius: 16px;
      color: #0f0;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .log-line {
      margin: 0;
      line-height: 1.4;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>PID å‚æ•°è°ƒè°å™¨</h1>

    <div class="control-row">
      <select id="pidType">
        <option value="balance_pitch">å¹³è¡¡ Pitch</option>
        <option value="balance_yaw">åèˆª Yaw</option>
        <option value="speed">é€Ÿåº¦ Speed</option>
      </select>
      <button class="submit-btn" id="submitBtn">æäº¤å¹¶ç­‰å¾…é‡å¯</button>
    </div>

    <!-- Pitch -->
    <div class="param-section" id="section_pitch">
      <h3>å¹³è¡¡ Pitch</h3>
      <div class="param-row">
        <span class="param-label">Kp</span>
        <input type="range" id="pitch_kp" min="0" max="2000" step="1" value="850">
        <span class="value-display" id="pitch_kp_val">850</span>
      </div>
      <div class="param-row">
        <span class="param-label">Ki</span>
        <input type="range" id="pitch_ki" min="0" max="10" step="0.1" value="0">
        <span class="value-display" id="pitch_ki_val">0</span>
      </div>
      <div class="param-row">
        <span class="param-label">Kd</span>
        <input type="range" id="pitch_kd" min="0" max="10" step="0.1" value="2.6">
        <span class="value-display" id="pitch_kd_val">2.6</span>
      </div>
    </div>

    <!-- Yaw -->
    <div class="param-section" id="section_yaw">
      <h3>åèˆª Yaw</h3>
      <div class="param-row">
        <span class="param-label">Kp</span>
        <input type="range" id="yaw_kp" min="0" max="100" step="1" value="30">
        <span class="value-display" id="yaw_kp_val">30</span>
      </div>
      <div class="param-row">
        <span class="param-label">Ki</span>
        <input type="range" id="yaw_ki" min="0" max="10" step="0.1" value="0">
        <span class="value-display" id="yaw_ki_val">0</span>
      </div>
      <div class="param-row">
        <span class="param-label">Kd</span>
        <input type="range" id="yaw_kd" min="0" max="10" step="0.1" value="1">
        <span class="value-display" id="yaw_kd_val">1</span>
      </div>
    </div>

    <!-- Speed -->
    <div class="param-section" id="section_speed">
      <h3>é€Ÿåº¦ Speed</h3>
      <div class="param-row">
        <span class="param-label">Kp</span>
        <input type="range" id="speed_kp" min="0" max="10" step="0.1" value="1">
        <span class="value-display" id="speed_kp_val">1</span>
      </div>
      <div class="param-row">
        <span class="param-label">Ki</span>
        <input type="range" id="speed_ki" min="0" max="5" step="0.01" value="0.1">
        <span class="value-display" id="speed_ki_val">0.1</span>
      </div>
      <div class="param-row">
        <span class="param-label">Kd</span>
        <input type="range" id="speed_kd" min="0" max="1" step="0.01" value="0.01">
        <span class="value-display" id="speed_kd_val">0.01</span>
      </div>
    </div>

    <div class="monitor" id="monitor">
      <p class="log-line">ä¸²å£ç›‘è§†å™¨ï¼ˆç­‰å¾…è¿æ¥...ï¼‰</p>
    </div>
  </div>

  <script>
    // ========== å…¨å±€çŠ¶æ€ ==========
    let currentPort = null;
    let isConnected = false;
    let logLines = [];
    const monitorEl = document.getElementById('monitor');
    const pidTypeSelect = document.getElementById('pidType');
    const submitBtn = document.getElementById('submitBtn');

    // ========== UI å…ƒç´  ==========
    let connectBtn = null;
    let downloadBtn = null;
    let clearLogBtn = null;

    // ========== æ»‘å—ç»‘å®š ==========
    const sliderIds = [
      'pitch_kp', 'pitch_ki', 'pitch_kd',
      'yaw_kp', 'yaw_ki', 'yaw_kd',
      'speed_kp', 'speed_ki', 'speed_kd'
    ];

    sliderIds.forEach(id => {
      const slider = document.getElementById(id);
      const valEl = document.getElementById(id + '_val');
      slider.addEventListener('input', () => {
        const val = parseFloat(slider.value);
        valEl.textContent = val.toFixed(slider.step < 1 ? 3 : 0);
      });
    });

    // ========== åˆ‡æ¢ PID ç±»å‹ ==========
    pidTypeSelect.addEventListener('change', () => {
      document.querySelectorAll('.param-section').forEach(el => el.classList.remove('active'));
      const type = pidTypeSelect.value;
      const sectionMap = {
        'balance_pitch': 'section_pitch',
        'balance_yaw': 'section_yaw',
        'speed': 'section_speed'
      };
      document.getElementById(sectionMap[type]).classList.add('active');
    });

    document.getElementById('section_pitch').classList.add('active');

    // ========== æ—¥å¿— ==========
    function log(msg) {
      const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logLines.push(line);
      if (logLines.length > 100) logLines.shift();
      monitorEl.innerHTML = logLines.map(l => `<p class="log-line">${l}</p>`).join('');
      monitorEl.scrollTop = monitorEl.scrollHeight;
    }

    function clearLog() {
      logLines = [];
      monitorEl.innerHTML = '<p class="log-line">æ—¥å¿—å·²æ¸…ç©º</p>';
    }

    // ========== ä¸²å£è¯»å– ==========
    async function readFromPort(port) {
      const reader = port.readable.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      try {
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();
          for (const line of lines) {
            const cleanLine = line.trim();
            if (!cleanLine) continue;
            log(`â† ${cleanLine}`);
            try {
              const jsonObj = JSON.parse(cleanLine);
              if (jsonObj.data) {
                updateSliders(jsonObj.data);
                log("âœ… è‡ªåŠ¨åŠ è½½è®¾å¤‡å‚æ•°");
              }
            } catch (e) { }
          }
        }
      } catch (e) {
        if (isConnected) {
          log(`âŒ è¯»å–ä¸­æ–­: ${e.message}`);
        }
      } finally {
        reader.releaseLock();
        if (isConnected) {
          handleDisconnect();
        }
      }
    }

    // ========== å‘é€ JSON ==========
    async function sendJSON(jsonStr) {
      if (!isConnected || !currentPort?.writable) {
        log("âŒ ä¸²å£æœªè¿æ¥ï¼Œæ— æ³•å‘é€");
        return false;
      }
      const writer = currentPort.writable.getWriter();
      try {
        await writer.write(new TextEncoder().encode(jsonStr + "\n"));
        log(`â†’ ${jsonStr}`);
        return true;
      } catch (e) {
        log(`âŒ å‘é€å¤±è´¥: ${e.message}`);
        return false;
      } finally {
        writer.releaseLock();
      }
    }

    // ========== æ›´æ–°æ»‘å— ==========
    function updateSliders(dataObj) {
      const fields = ['pitch_kp', 'pitch_ki', 'pitch_kd', 'yaw_kp', 'yaw_ki', 'yaw_kd', 'speed_kp', 'speed_ki', 'speed_kd'];
      fields.forEach(field => {
        if (dataObj[field] !== undefined) {
          const slider = document.getElementById(field);
          const val = parseFloat(dataObj[field]);
          slider.value = val;
          document.getElementById(field + '_val').textContent = val.toFixed(3);
        }
      });
    }

    // ========== å¤„ç†è¿æ¥ ==========
    async function handleConnect() {
      // âœ… å…³é”®ä¿®å¤ï¼šå¦‚æœå·²è¿æ¥ï¼Œå…ˆæ–­å¼€
      if (isConnected) {
        await handleDisconnect();
      }

      try {
        const port = await navigator.serial.requestPort();

        // âœ… æ£€æŸ¥æ˜¯å¦å·²æ‰“å¼€ï¼ˆé˜²é‡å¤ï¼‰
        if (port.readable || port.writable) {
          log("âš ï¸ ç«¯å£å·²æ‰“å¼€ï¼Œè·³è¿‡é‡å¤æ‰“å¼€");
          currentPort = port;
          isConnected = true;
          connectBtn.textContent = "æ–­å¼€ä¸²å£";
          return;
        }

        await port.open({ baudRate: 115200 });
        if (!port.readable) throw new Error('ä¸²å£ä¸å¯è¯»');

        currentPort = port;
        isConnected = true;
        connectBtn.textContent = "æ–­å¼€ä¸²å£";
        log("âœ… ä¸²å£å·²è¿æ¥");
        readFromPort(port);
      } catch (error) {
        isConnected = false;
        if (connectBtn) connectBtn.textContent = "è¿æ¥ä¸²å£";
        log(`âŒ ${error.message || 'ä¸²å£è¿æ¥å¤±è´¥'}`);
      }
    }

    // ========== å¤„ç†æ–­å¼€ ==========
    async function handleDisconnect() {
      if (!currentPort) {
        isConnected = false;
        return;
      }

      try {
        // å…ˆåœæ­¢è¯»å–ï¼ˆå¦‚æœæœ‰ readerï¼‰
        if (currentPort.readable) {
          const reader = currentPort.readable.getReader();
          await reader.cancel();
          reader.releaseLock();
        }
        await currentPort.close();
      } catch (e) {
        // å¿½ç•¥å…³é—­é”™è¯¯
      } finally {
        currentPort = null;
        isConnected = false;
        if (connectBtn) connectBtn.textContent = "è¿æ¥ä¸²å£";
        log("ğŸ”Œ ä¸²å£å·²æ–­å¼€");
      }
    }

    // ========== æäº¤æŒ‰é’® ==========
    submitBtn.addEventListener('click', async () => {
      if (!isConnected) {
        log("âš ï¸ è¯·å…ˆè¿æ¥ä¸²å£");
        return;
      }

      const type = pidTypeSelect.value;
      // ä» type è·å– slider å‰ç¼€ (balance_pitch â†’ pitch)
      const prefix = type.split('_')[1];

      const kp = parseFloat(document.getElementById(`${prefix}_kp`).value);
      const ki = parseFloat(document.getElementById(`${prefix}_ki`).value);
      const kd = parseFloat(document.getElementById(`${prefix}_kd`).value);

      const jsonToSend = `{"type":"${type}","kp":${kp.toFixed(1)},"ki":${ki.toFixed(1)},"kd":${kd.toFixed(1)}}`;
      log("ğŸ“¤ å‘é€ PID å‚æ•°: " + jsonToSend);

      const success = await sendJSON(jsonToSend);
      if (success) {
        submitBtn.disabled = true;
        submitBtn.textContent = "ç­‰å¾…é‡å¯...";
        log("â³ ç­‰å¾…è®¾å¤‡é‡å¯...");

        // ç­‰å¾…è®¾å¤‡å¤„ç†å¹¶å¤ä½
        await new Promise(r => setTimeout(r, 300));
        await handleDisconnect();

        await new Promise(r => setTimeout(r, 2000));
        log("ğŸ”„ å°è¯•é‡æ–°è¿æ¥...");
        await handleConnect();

        submitBtn.disabled = false;
        submitBtn.textContent = "æäº¤å¹¶ç­‰å¾…é‡å¯";
      }
    });

    // ========== ä¸‹è½½å½“å‰é…ç½® ==========
    function downloadCurrentConfig() {
      const config = {
        balance_pitch: {
          type: "balance_pitch",
          kp: parseFloat(pitch_kp.value),
          ki: parseFloat(pitch_ki.value),
          kd: parseFloat(pitch_kd.value)
        },
        balance_yaw: {
          type: "balance_yaw",
          kp: parseFloat(yaw_kp.value),
          ki: parseFloat(yaw_ki.value),
          kd: parseFloat(yaw_kd.value)
        },
        speed: {
          type: "speed",
          kp: parseFloat(speed_kp.value),
          ki: parseFloat(speed_ki.value),
          kd: parseFloat(speed_kd.value)
        }
      };

      const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'pid_config_backup.json';
      a.click();
      URL.revokeObjectURL(url);
      log("ğŸ’¾ å·²ä¸‹è½½å½“å‰é…ç½®");
    }

    // ========== åˆå§‹åŒ– UI ==========
    document.addEventListener('DOMContentLoaded', () => {
      // åˆ›å»ºæŒ‰é’®å®¹å™¨
      const btnContainer = document.createElement('div');
      btnContainer.style.display = 'flex';
      btnContainer.style.gap = '12px';
      btnContainer.style.marginTop = '12px';

      // è¿æ¥/æ–­å¼€æŒ‰é’®
      connectBtn = document.createElement('button');
      connectBtn.textContent = "è¿æ¥ä¸²å£";
      connectBtn.style.padding = "8px 16px";
      connectBtn.style.borderRadius = "16px";
      connectBtn.onclick = () => {
        if (isConnected) {
          handleDisconnect();
        } else {
          handleConnect();
        }
      };
      btnContainer.appendChild(connectBtn);

      // ä¸‹è½½é…ç½®æŒ‰é’®
      downloadBtn = document.createElement('button');
      downloadBtn.textContent = "ä¸‹è½½é…ç½®";
      downloadBtn.style.padding = "8px 16px";
      downloadBtn.style.borderRadius = "16px";
      downloadBtn.style.backgroundColor = "#34a853";
      downloadBtn.style.color = "white";
      downloadBtn.onclick = downloadCurrentConfig;
      btnContainer.appendChild(downloadBtn);

      // æ¸…ç©ºæ—¥å¿—æŒ‰é’®
      clearLogBtn = document.createElement('button');
      clearLogBtn.textContent = "æ¸…ç©ºæ—¥å¿—";
      clearLogBtn.style.padding = "8px 16px";
      clearLogBtn.style.borderRadius = "16px";
      clearLogBtn.style.backgroundColor = "#ea4335";
      clearLogBtn.style.color = "white";
      clearLogBtn.onclick = clearLog;
      btnContainer.appendChild(clearLogBtn);

      document.querySelector('.control-row').appendChild(btnContainer);
      log("â„¹ï¸ ç‚¹å‡»ã€Œè¿æ¥ä¸²å£ã€å¼€å§‹");
    });
  </script>
</body>

</html>